<!DOCTYPE html>
<html lang="zh-TW">
<head><script type='text/javascript' src='https://bhe3a9h638j3jas6.canva-hosted-embed.com/AUSSs8kf2OfMD9QAx_MpEerPMwkSKBJhB1Yx5uEgnEvX-oqTBx9TZbedLjdQ4ZWfgvdTjT0DqwnnvOxAlKO08Q=='></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±å—éŠ˜ç‰ˆæœ‰é™å…¬å¸ - è¨˜å¸³ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --secondary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            --success-gradient: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        /* æ·±è‰²ä¸»é¡Œ */
        body.dark-theme {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        /* æ·ºè‰²ä¸»é¡Œ */
        body.light-theme {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .header {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .light-theme .header {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--primary-gradient);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tab-button {
            background: var(--primary-gradient);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .tab-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .tab-button.active {
            background: var(--secondary-gradient);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .dark-theme .card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .light-theme .card {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .dark-theme .form-group input,
        .dark-theme .form-group select,
        .dark-theme .form-group textarea {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .light-theme .form-group input,
        .light-theme .form-group select,
        .light-theme .form-group textarea {
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
        }

        .btn {
            background: var(--primary-gradient);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-danger {
            background: var(--danger-gradient);
        }

        .btn-success {
            background: var(--success-gradient);
        }

        .btn-secondary {
            background: var(--secondary-gradient);
        }

        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .dark-theme .record-item {
            background: rgba(255, 255, 255, 0.05);
        }

        .light-theme .record-item {
            background: rgba(255, 255, 255, 0.5);
        }

        .record-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .income {
            color: #28a745;
            font-weight: bold;
        }

        .expense {
            color: #dc3545;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.5s ease;
        }

        .notification.success {
            background: var(--success-gradient);
        }

        .notification.error {
            background: var(--danger-gradient);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .dark-theme .stat-card {
            background: rgba(255, 255, 255, 0.1);
        }

        .light-theme .stat-card {
            background: rgba(255, 255, 255, 0.3);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .category-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .dark-theme .category-item {
            background: rgba(255, 255, 255, 0.1);
        }

        .light-theme .category-item {
            background: rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-button {
                width: 100%;
                margin: 5px 0;
            }
            
            .record-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="dark-theme">
    <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™ åˆ‡æ›ä¸»é¡Œ</button>
    
    <div class="container">
        <div class="header">
            <h1>æ±å—éŠ˜ç‰ˆæœ‰é™å…¬å¸</h1>
            <h2>è¨˜å¸³ç®¡ç†ç³»çµ±</h2>
            <p>å°ˆæ¥­çš„è²¡å‹™ç®¡ç†è§£æ±ºæ–¹æ¡ˆ</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('accounting')">è¨˜å¸³ç®¡ç†</button>
            <button class="tab-button" onclick="showTab('categories')">åˆ†é¡ç®¡ç†</button>
            <button class="tab-button" onclick="showTab('records')">è¨˜å¸³æ˜ç´°</button>
            <button class="tab-button" onclick="showTab('statistics')">çµ±è¨ˆåˆ†æ</button>
            <button class="tab-button" onclick="showTab('export')">è³‡æ–™åŒ¯å‡º</button>
        </div>

        <!-- è¨˜å¸³ç®¡ç† -->
        <div id="accounting" class="tab-content active">
            <div class="card">
                <h3>æ–°å¢è¨˜å¸³è¨˜éŒ„</h3>
                <form id="accountingForm">
                    <div class="form-group">
                        <label for="amount">é‡‘é¡</label>
                        <input type="number" id="amount" required min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="type">é¡å‹</label>
                        <select id="type" required>
                            <option value="">è«‹é¸æ“‡é¡å‹</option>
                            <option value="income">æ”¶å…¥</option>
                            <option value="expense">æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="category">åˆ†é¡</label>
                        <select id="category" required>
                            <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="date">æ—¥æœŸ</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="note">å‚™è¨»</label>
                        <textarea id="note" rows="3" placeholder="è«‹è¼¸å…¥å‚™è¨»..."></textarea>
                    </div>
                    <button type="submit" class="btn">æ–°å¢è¨˜éŒ„</button>
                </form>
            </div>
        </div>

        <!-- åˆ†é¡ç®¡ç† -->
        <div id="categories" class="tab-content">
            <div class="card">
                <h3>æ–°å¢åˆ†é¡</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="newCategory" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±..." style="flex: 1;">
                    <button class="btn" onclick="addCategory()">æ–°å¢åˆ†é¡</button>
                </div>
                <div class="category-list" id="categoryList"></div>
            </div>
        </div>

        <!-- è¨˜å¸³æ˜ç´° -->
        <div id="records" class="tab-content">
            <div class="card">
                <h3>è¨˜å¸³æ˜ç´°æŸ¥è©¢</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input type="date" id="startDate" style="flex: 1; min-width: 150px;">
                    <input type="date" id="endDate" style="flex: 1; min-width: 150px;">
                    <button class="btn" onclick="filterRecords()">ç¯©é¸</button>
                    <button class="btn btn-secondary" onclick="clearFilter()">æ¸…é™¤ç¯©é¸</button>
                </div>
                <div class="record-list" id="recordList"></div>
            </div>
        </div>

        <!-- çµ±è¨ˆåˆ†æ -->
        <div id="statistics" class="tab-content">
            <div class="card">
                <h3>çµ±è¨ˆåˆ†æ</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <select id="statsType" style="flex: 1; min-width: 150px;">
                        <option value="category">ä¾åˆ†é¡çµ±è¨ˆ</option>
                        <option value="month">ä¾æœˆä»½çµ±è¨ˆ</option>
                        <option value="date">ä¾æ—¥æœŸçµ±è¨ˆ</option>
                    </select>
                    <input type="date" id="statsStartDate" style="flex: 1; min-width: 150px;">
                    <input type="date" id="statsEndDate" style="flex: 1; min-width: 150px;">
                    <button class="btn" onclick="generateStats()">ç”Ÿæˆçµ±è¨ˆ</button>
                </div>
                
                <div class="stats-grid" id="statsGrid"></div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="chartType">
                        <option value="pie">åœ“é¤…åœ–</option>
                        <option value="bar">æŸ±ç‹€åœ–</option>
                    </select>
                    <button class="btn btn-success" onclick="downloadChart('jpg')">ä¸‹è¼‰ JPG</button>
                    <button class="btn btn-success" onclick="downloadChart('svg')">ä¸‹è¼‰ SVG</button>
                </div>
                
                <div class="chart-container">
                    <canvas id="statsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- è³‡æ–™åŒ¯å‡º -->
        <div id="export" class="tab-content">
            <div class="card">
                <h3>è³‡æ–™åŒ¯å‡º</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input type="date" id="exportStartDate" style="flex: 1; min-width: 150px;">
                    <input type="date" id="exportEndDate" style="flex: 1; min-width: 150px;">
                    <button class="btn btn-success" onclick="exportData('txt')">åŒ¯å‡º TXT</button>
                    <button class="btn btn-success" onclick="exportData('csv')">åŒ¯å‡º CSV</button>
                </div>
                <div id="exportPreview" style="max-height: 300px; overflow-y: auto; padding: 15px; border-radius: 10px; font-family: monospace;"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let records = JSON.parse(localStorage.getItem('records')) || [];
        let categories = JSON.parse(localStorage.getItem('categories')) || [
            'é¤é£²', 'äº¤é€šè²»', 'æ–‡å…·', 'è¬›å¸«è²»', 'æˆ¿ç§Ÿ', 'æ°´é›»è²»', 'é›»è©±è²»', 'ç¶²è·¯è²»',
            'ä¿éšªè²»', 'é†«ç™‚è²»', 'å¨›æ¨‚', 'è³¼ç‰©', 'æ—…éŠ', 'æ•™è‚²', 'æŠ•è³‡', 'è–ªè³‡',
            'çé‡‘', 'åˆ©æ¯', 'å…¶ä»–æ”¶å…¥', 'å…¶ä»–æ”¯å‡º'
        ];
        let currentChart = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // è¨­å®šç•¶å‰æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            document.getElementById('statsStartDate').value = today;
            document.getElementById('statsEndDate').value = today;
            document.getElementById('exportStartDate').value = today;
            document.getElementById('exportEndDate').value = today;

            // è¼‰å…¥ä¸»é¡Œè¨­å®š
            const savedTheme = localStorage.getItem('theme') || 'dark-theme';
            document.body.className = savedTheme;
            updateThemeToggle();

            // åˆå§‹åŒ–å„åŠŸèƒ½
            loadCategories();
            loadRecords();
            setupEventListeners();
        }

        function setupEventListeners() {
            document.getElementById('accountingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addRecord();
            });
        }

        // ä¸»é¡Œåˆ‡æ›
        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('dark-theme')) {
                body.className = 'light-theme';
                localStorage.setItem('theme', 'light-theme');
            } else {
                body.className = 'dark-theme';
                localStorage.setItem('theme', 'dark-theme');
            }
            updateThemeToggle();
        }

        function updateThemeToggle() {
            const toggle = document.querySelector('.theme-toggle');
            if (document.body.classList.contains('dark-theme')) {
                toggle.innerHTML = 'â˜€ï¸ æ·ºè‰²ä¸»é¡Œ';
            } else {
                toggle.innerHTML = 'ğŸŒ™ æ·±è‰²ä¸»é¡Œ';
            }
        }

        // é ç±¤åˆ‡æ›
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰é ç±¤å…§å®¹
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));

            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active é¡åˆ¥
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));

            // é¡¯ç¤ºé¸ä¸­çš„é ç±¤
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // ç‰¹æ®Šè™•ç†
            if (tabName === 'records') {
                loadRecords();
            } else if (tabName === 'categories') {
                loadCategories();
            }
        }

        // é€šçŸ¥ç³»çµ±
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // è¨˜å¸³åŠŸèƒ½
        function addRecord() {
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;
            const date = document.getElementById('date').value;
            const note = document.getElementById('note').value;

            if (!amount || !type || !category || !date) {
                showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }

            const record = {
                id: Date.now(),
                amount: type === 'expense' ? -amount : amount,
                type,
                category,
                date,
                note,
                timestamp: new Date().toISOString()
            };

            records.push(record);
            localStorage.setItem('records', JSON.stringify(records));
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('accountingForm').reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            showNotification('è¨˜éŒ„æ–°å¢æˆåŠŸï¼');
        }

        // åˆ†é¡ç®¡ç†
        function loadCategories() {
            const categorySelect = document.getElementById('category');
            const categoryList = document.getElementById('categoryList');
            
            // æ›´æ–°ä¸‹æ‹‰é¸å–®
            categorySelect.innerHTML = '<option value="">è«‹é¸æ“‡åˆ†é¡</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });

            // æ›´æ–°åˆ†é¡åˆ—è¡¨
            if (categoryList) {
                categoryList.innerHTML = '';
                categories.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    item.innerHTML = `
                        <span>${category}</span>
                        <button class="btn btn-danger" onclick="deleteCategory('${category}')">åˆªé™¤</button>
                    `;
                    categoryList.appendChild(item);
                });
            }
        }

        function addCategory() {
            const newCategory = document.getElementById('newCategory').value.trim();
            
            if (!newCategory) {
                showNotification('è«‹è¼¸å…¥åˆ†é¡åç¨±', 'error');
                return;
            }

            if (categories.includes(newCategory)) {
                showNotification('åˆ†é¡å·²å­˜åœ¨', 'error');
                return;
            }

            categories.push(newCategory);
            localStorage.setItem('categories', JSON.stringify(categories));
            document.getElementById('newCategory').value = '';
            loadCategories();
            showNotification('åˆ†é¡æ–°å¢æˆåŠŸï¼');
        }

        function deleteCategory(category) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤åˆ†é¡ã€Œ${category}ã€å—ï¼Ÿ`)) {
                categories = categories.filter(c => c !== category);
                localStorage.setItem('categories', JSON.stringify(categories));
                loadCategories();
                showNotification('åˆ†é¡åˆªé™¤æˆåŠŸï¼');
            }
        }

        // è¨˜éŒ„ç®¡ç†
        function loadRecords() {
            const recordList = document.getElementById('recordList');
            if (!recordList) return;

            recordList.innerHTML = '';
            
            // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
            const sortedRecords = [...records].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedRecords.forEach(record => {
                const item = document.createElement('div');
                item.className = 'record-item';
                
                const amountClass = record.amount > 0 ? 'income' : 'expense';
                const amountText = record.amount > 0 ? `+${record.amount}` : record.amount;
                
                item.innerHTML = `
                    <div>
                        <div><strong>${record.category}</strong></div>
                        <div>${record.date}</div>
                        <div>${record.note || 'ç„¡å‚™è¨»'}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="${amountClass}">$${amountText}</div>
                        <button class="btn btn-danger" onclick="deleteRecord(${record.id})">åˆªé™¤</button>
                    </div>
                `;
                recordList.appendChild(item);
            });
        }

        function deleteRecord(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
                records = records.filter(record => record.id !== id);
                localStorage.setItem('records', JSON.stringify(records));
                loadRecords();
                showNotification('è¨˜éŒ„åˆªé™¤æˆåŠŸï¼');
            }
        }

        function filterRecords() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showNotification('è«‹é¸æ“‡æ—¥æœŸç¯„åœ', 'error');
                return;
            }

            const recordList = document.getElementById('recordList');
            recordList.innerHTML = '';
            
            const filteredRecords = records.filter(record => {
                return record.date >= startDate && record.date <= endDate;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredRecords.forEach(record => {
                const item = document.createElement('div');
                item.className = 'record-item';
                
                const amountClass = record.amount > 0 ? 'income' : 'expense';
                const amountText = record.amount > 0 ? `+${record.amount}` : record.amount;
                
                item.innerHTML = `
                    <div>
                        <div><strong>${record.category}</strong></div>
                        <div>${record.date}</div>
                        <div>${record.note || 'ç„¡å‚™è¨»'}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="${amountClass}">$${amountText}</div>
                        <button class="btn btn-danger" onclick="deleteRecord(${record.id})">åˆªé™¤</button>
                    </div>
                `;
                recordList.appendChild(item);
            });
            
            showNotification(`æ‰¾åˆ° ${filteredRecords.length} ç­†è¨˜éŒ„`);
        }

        function clearFilter() {
            loadRecords();
            showNotification('ç¯©é¸å·²æ¸…é™¤');
        }

        // çµ±è¨ˆåˆ†æ
        function generateStats() {
            const statsType = document.getElementById('statsType').value;
            const startDate = document.getElementById('statsStartDate').value;
            const endDate = document.getElementById('statsEndDate').value;
            
            if (!startDate || !endDate) {
                showNotification('è«‹é¸æ“‡çµ±è¨ˆæ—¥æœŸç¯„åœ', 'error');
                return;
            }

            const filteredRecords = records.filter(record => {
                return record.date >= startDate && record.date <= endDate;
            });

            let statsData = {};
            let labels = [];
            let values = [];

            if (statsType === 'category') {
                filteredRecords.forEach(record => {
                    if (!statsData[record.category]) {
                        statsData[record.category] = 0;
                    }
                    statsData[record.category] += Math.abs(record.amount);
                });
            } else if (statsType === 'month') {
                filteredRecords.forEach(record => {
                    const month = record.date.substring(0, 7);
                    if (!statsData[month]) {
                        statsData[month] = 0;
                    }
                    statsData[month] += Math.abs(record.amount);
                });
            } else if (statsType === 'date') {
                filteredRecords.forEach(record => {
                    if (!statsData[record.date]) {
                        statsData[record.date] = 0;
                    }
                    statsData[record.date] += Math.abs(record.amount);
                });
            }

            labels = Object.keys(statsData);
            values = Object.values(statsData);

            // æ›´æ–°çµ±è¨ˆå¡ç‰‡
            updateStatsGrid(filteredRecords);
            
            // ç”Ÿæˆåœ–è¡¨
            generateChart(labels, values, statsType);
        }

        function updateStatsGrid(filteredRecords) {
            const statsGrid = document.getElementById('statsGrid');
            
            const totalIncome = filteredRecords.filter(r => r.amount > 0).reduce((sum, r) => sum + r.amount, 0);
            const totalExpense = filteredRecords.filter(r => r.amount < 0).reduce((sum, r) => sum + Math.abs(r.amount), 0);
            const balance = totalIncome - totalExpense;
            const recordCount = filteredRecords.length;

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value income">$${totalIncome.toFixed(2)}</div>
                    <div>ç¸½æ”¶å…¥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value expense">$${totalExpense.toFixed(2)}</div>
                    <div>ç¸½æ”¯å‡º</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: ${balance >= 0 ? '#28a745' : '#dc3545'}">$${balance.toFixed(2)}</div>
                    <div>æ·¨æ”¶æ”¯</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${recordCount}</div>
                    <div>è¨˜éŒ„ç­†æ•¸</div>
                </div>
            `;
        }

        function generateChart(labels, values, statsType) {
            const ctx = document.getElementById('statsChart').getContext('2d');
            const chartType = document.getElementById('chartType').value;
            
            if (currentChart) {
                currentChart.destroy();
            }

            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];

            currentChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é‡‘é¡',
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: colors.slice(0, labels.length),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${getStatsTypeText(statsType)}çµ±è¨ˆåœ–è¡¨`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: chartType === 'pie'
                        }
                    },
                    scales: chartType === 'bar' ? {
                        y: {
                            beginAtZero: true
                        }
                    } : {}
                }
            });
        }

        function getStatsTypeText(type) {
            switch(type) {
                case 'category': return 'åˆ†é¡';
                case 'month': return 'æœˆä»½';
                case 'date': return 'æ—¥æœŸ';
                default: return '';
            }
        }

        // åœ–è¡¨ä¸‹è¼‰
        function downloadChart(format) {
            if (!currentChart) {
                showNotification('è«‹å…ˆç”Ÿæˆçµ±è¨ˆåœ–è¡¨', 'error');
                return;
            }

            const canvas = document.getElementById('statsChart');
            const statsType = document.getElementById('statsType').value;
            const filename = `çµ±è¨ˆåœ–è¡¨_${getStatsTypeText(statsType)}_${new Date().toISOString().split('T')[0]}`;

            if (format === 'jpg') {
                // å‰µå»ºæ–°çš„ canvas åŠ ä¸Šç™½è‰²èƒŒæ™¯
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                
                // å¡«å……ç™½è‰²èƒŒæ™¯
                tempCtx.fillStyle = 'white';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // ç¹ªè£½åŸåœ–è¡¨
                tempCtx.drawImage(canvas, 0, 0);
                
                const link = document.createElement('a');
                link.download = `${filename}.jpg`;
                link.href = tempCanvas.toDataURL('image/jpeg', 0.9);
                link.click();
            } else if (format === 'svg') {
                // SVG ä¸‹è¼‰éœ€è¦é‡æ–°å¯¦ç¾ï¼Œé€™è£¡ä½¿ç”¨ PNG æ›¿ä»£
                const link = document.createElement('a');
                link.download = `${filename}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
            
            showNotification(`åœ–è¡¨å·²ä¸‹è¼‰ç‚º ${format.toUpperCase()} æ ¼å¼`);
        }

        // è³‡æ–™åŒ¯å‡º
        function exportData(format) {
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            
            if (!startDate || !endDate) {
                showNotification('è«‹é¸æ“‡åŒ¯å‡ºæ—¥æœŸç¯„åœ', 'error');
                return;
            }

            const filteredRecords = records.filter(record => {
                return record.date >= startDate && record.date <= endDate;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredRecords.length === 0) {
                showNotification('é¸å®šæ—¥æœŸç¯„åœå…§ç„¡è¨˜éŒ„', 'error');
                return;
            }

            let content = '';
            const filename = `è¨˜å¸³æ˜ç´°_${startDate}_${endDate}`;

            if (format === 'txt') {
                content = 'æ±å—éŠ˜ç‰ˆæœ‰é™å…¬å¸ - è¨˜å¸³æ˜ç´°\n';
                content += `åŒ¯å‡ºæ—¥æœŸï¼š${new Date().toLocaleDateString()}\n`;
                content += `è³‡æ–™ç¯„åœï¼š${startDate} è‡³ ${endDate}\n`;
                content += '='.repeat(50) + '\n\n';
                
                filteredRecords.forEach(record => {
                    content += `æ—¥æœŸï¼š${record.date}\n`;
                    content += `åˆ†é¡ï¼š${record.category}\n`;
                    content += `é¡å‹ï¼š${record.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}\n`;
                    content += `é‡‘é¡ï¼š$${Math.abs(record.amount)}\n`;
                    content += `å‚™è¨»ï¼š${record.note || 'ç„¡'}\n`;
                    content += '-'.repeat(30) + '\n';
                });
            } else if (format === 'csv') {
                content = 'æ—¥æœŸ,åˆ†é¡,é¡å‹,é‡‘é¡,å‚™è¨»\n';
                filteredRecords.forEach(record => {
                    content += `${record.date},${record.category},${record.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'},${Math.abs(record.amount)},"${record.note || ''}"\n`;
                });
            }

            // é¡¯ç¤ºé è¦½
            const preview = document.getElementById('exportPreview');
            preview.innerHTML = `<pre>${content}</pre>`;

            // ä¸‹è¼‰æª”æ¡ˆ
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}.${format}`;
            link.click();
            
            showNotification(`è³‡æ–™å·²åŒ¯å‡ºç‚º ${format.toUpperCase()} æ ¼å¼`);
        }

        // é˜²æŠ–å‡½æ•¸
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966226e6517a8421',t:'MTc1MzY4MjM4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
